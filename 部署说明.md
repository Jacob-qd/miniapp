# 微信小程序商务系统部署说明

## 项目概述

本项目是一个完整的微信小程序商务系统，包含：
- 管理后台（React + Vite + Ant Design）
- 微信小程序端
- 后端API服务（Express + Supabase）

## 部署准备

### 1. 项目构建

项目已成功构建，生成的文件位于 `dist/` 目录：
- `dist/index.html` - 主页面文件
- `dist/assets/` - 静态资源文件

### 2. 配置文件检查

✅ **已完成的配置：**
- `vercel.json` - Vercel部署配置
- `package.json` - 项目依赖和构建脚本
- `.env.production` - 生产环境变量模板

## Vercel部署步骤

### 方式一：通过Vercel CLI（推荐）

1. **登录Vercel账户**
   ```bash
   npx vercel login
   ```
   选择合适的登录方式（GitHub、Google、Email等）

2. **部署项目**
   ```bash
   npx vercel --prod
   ```
   首次部署时会提示配置项目设置

3. **设置环境变量**
   在Vercel Dashboard中设置以下环境变量：
   ```
   SUPABASE_URL=你的Supabase项目URL
   SUPABASE_ANON_KEY=你的Supabase匿名密钥
   SUPABASE_SERVICE_ROLE_KEY=你的Supabase服务密钥
   VITE_SUPABASE_URL=你的Supabase项目URL
   VITE_SUPABASE_ANON_KEY=你的Supabase匿名密钥
   JWT_SECRET=你的JWT密钥
   NODE_ENV=production
   ```

### 方式二：通过Vercel Dashboard

1. 访问 [vercel.com](https://vercel.com)
2. 登录并点击 "New Project"
3. 导入Git仓库或上传项目文件
4. 配置构建设置：
   - Framework Preset: Vite
   - Build Command: `npm run build`
   - Output Directory: `dist`
5. 添加环境变量（同上）
6. 点击 "Deploy"

## 环境变量配置

### Supabase配置

⚠️ **重要提示：** 当前Supabase集成出现问题，需要手动配置：

1. 登录你的Supabase项目
2. 获取以下信息：
   - Project URL
   - Anon Key
   - Service Role Key
3. 在Vercel Dashboard的项目设置中添加环境变量

### JWT密钥

生成一个强密钥用于JWT签名：
```bash
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

## 部署后验证

### 1. 访问管理后台

部署成功后，你将获得一个Vercel域名，例如：
`https://your-project-name.vercel.app`

### 2. 功能测试

- ✅ 登录页面访问
- ✅ 管理后台各模块功能
- ✅ API接口调用
- ✅ 数据库连接

### 3. 微信小程序配置

更新小程序中的API地址：
```javascript
// miniprogram/utils/api.js
const API_BASE_URL = 'https://your-project-name.vercel.app/api';
```

## 常见问题

### 1. 构建错误

如果遇到构建错误，检查：
- Node.js版本兼容性
- 依赖包完整性
- TypeScript类型检查

### 2. 环境变量问题

确保所有必需的环境变量都已正确设置，特别是：
- Supabase相关配置
- JWT密钥
- API基础URL

### 3. API调用失败

检查：
- CORS配置
- Supabase连接
- 环境变量是否正确

## 项目结构

```
商务小程序/
├── dist/                 # 构建输出目录
├── src/                  # 前端源码
├── api/                  # 后端API
├── miniprogram/          # 微信小程序
├── supabase/            # 数据库配置
├── vercel.json          # Vercel配置
└── package.json         # 项目配置
```

## 技术栈

- **前端：** React 18 + Vite + Ant Design + TypeScript
- **后端：** Express + Node.js
- **数据库：** Supabase (PostgreSQL)
- **部署：** Vercel
- **小程序：** 微信小程序原生开发

## 支持

如需帮助，请检查：
1. Vercel部署日志
2. 浏览器控制台错误
3. Supabase项目状态
4. 环境变量配置

## 项目概述

本项目是一个完整的微信小程序商务系统，包含：
- **管理后台**: React + Ant Design + TypeScript
- **API服务**: Node.js + Express + TypeScript
- **微信小程序**: 原生微信小程序
- **数据库**: Supabase (PostgreSQL)

## 部署准备

### 1. 环境要求
- Node.js 18+
- npm 或 pnpm
- Vercel 账号
- Supabase 项目
- 微信小程序开发者账号

### 2. 必需配置
- Supabase 项目配置
- 微信小程序 AppID
- 域名（用于生产环境）

## 部署步骤

### 第一步：配置环境变量

1. **复制环境变量模板**
   ```bash
   cp .env.production .env.local
   ```

2. **更新 `.env.local` 文件**
   ```env
   # Supabase配置 - 替换为实际值
   SUPABASE_URL=https://your-project-id.supabase.co
   SUPABASE_ANON_KEY=your-actual-anon-key
   SUPABASE_SERVICE_ROLE_KEY=your-actual-service-key
   
   # Vite前端环境变量
   VITE_SUPABASE_URL=https://your-project-id.supabase.co
   VITE_SUPABASE_ANON_KEY=your-actual-anon-key
   
   # JWT密钥 - 生成强密钥
   JWT_SECRET=your-super-secret-jwt-key-min-32-chars
   
   # 生产环境配置
   NODE_ENV=production
   PORT=3001
   ```

### 第二步：部署到 Vercel

1. **安装 Vercel CLI**
   ```bash
   npm install -g vercel
   ```

2. **登录 Vercel**
   ```bash
   vercel login
   ```

3. **部署项目**
   ```bash
   vercel --prod
   ```

4. **配置环境变量**
   在 Vercel Dashboard 中设置环境变量：
   - `SUPABASE_URL`
   - `SUPABASE_ANON_KEY`
   - `SUPABASE_SERVICE_ROLE_KEY`
   - `JWT_SECRET`
   - `NODE_ENV=production`

### 第三步：配置域名和CORS

1. **更新 CORS 配置**
   在 `api/app.ts` 中更新允许的域名：
   ```typescript
   const corsOptions = {
     origin: [
       'https://your-actual-domain.vercel.app',
       'https://your-custom-domain.com'
     ],
     // ...
   };
   ```

2. **配置自定义域名**（可选）
   - 在 Vercel Dashboard 中添加自定义域名
   - 配置 DNS 记录

### 第四步：配置微信小程序

1. **更新 API 地址**
   在 `miniprogram/utils/api.js` 中：
   ```javascript
   const API_CONFIG = {
     baseUrl: 'https://your-actual-domain.vercel.app/api',
     // ...
   };
   ```

2. **配置服务器域名**
   在微信公众平台 > 开发 > 开发设置中配置：
   - request合法域名: `https://your-actual-domain.vercel.app`
   - uploadFile合法域名: `https://your-actual-domain.vercel.app`
   - downloadFile合法域名: `https://your-actual-domain.vercel.app`

3. **上传小程序代码**
   - 使用微信开发者工具打开 `miniprogram` 目录
   - 点击「上传」发布体验版
   - 测试无误后提交审核

## 验证部署

### 1. 管理后台验证
访问: `https://your-domain.vercel.app`
- [ ] 页面正常加载
- [ ] 登录功能正常
- [ ] 数据管理功能正常
- [ ] 实时同步功能正常

### 2. API 服务验证
访问: `https://your-domain.vercel.app/api/health`
应返回: `{"success": true, "message": "ok"}`

### 3. 微信小程序验证
- [ ] 首页数据加载正常
- [ ] 解决方案列表显示正常
- [ ] 产品服务页面正常
- [ ] 关于我们页面正常

## 常见问题

### 1. API 请求失败
- 检查 CORS 配置是否正确
- 确认环境变量设置正确
- 检查 Supabase 连接配置

### 2. 微信小程序无法访问 API
- 确认服务器域名已在微信公众平台配置
- 检查 HTTPS 证书是否有效
- 确认 API 地址配置正确

### 3. 构建失败
- 检查 TypeScript 类型错误
- 确认所有依赖已正确安装
- 检查环境变量是否完整

## 监控和维护

### 1. 日志监控
- Vercel Dashboard 查看函数日志
- Supabase Dashboard 监控数据库性能

### 2. 性能优化
- 定期检查 API 响应时间
- 优化数据库查询
- 监控小程序加载速度

### 3. 安全维护
- 定期更新依赖包
- 监控安全漏洞
- 备份重要数据

## 技术支持

如遇到部署问题，请检查：
1. 环境变量配置是否正确
2. 域名和 CORS 设置是否匹配
3. Supabase 项目是否正常运行
4. 微信小程序域名配置是否完整

---

**部署完成后的访问地址**:
- 管理后台: `https://your-domain.vercel.app`
- API 服务: `https://your-domain.vercel.app/api`
- 微信小程序: 通过微信扫码或搜索访问